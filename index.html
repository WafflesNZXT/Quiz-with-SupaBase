<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quiz Royale: The High Climb</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html, body { 
            overflow: hidden; width: 100%; height: 100%; margin: 0; padding: 0; 
            background: #1a1a2e; font-family: 'Segoe UI', sans-serif;
            touch-action: none; display: flex; flex-direction: column;
        }
        .hidden { display: none !important; }

        #game-container {
            position: relative; flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; padding-top: 10px;
        }

        #game-viewport { 
            position: relative; width: 95vw; max-width: 400px; height: 65vh; 
            background: #16213e; border: 3px solid #4ecca3; border-radius: 12px; overflow: hidden;
        }

        canvas { display: block; background: #0f3460; width: 100%; height: 100%; }

        #hud { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 10; }
        .stat-box { 
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 5px; 
            margin-bottom: 5px; font-size: 12px; border-left: 3px solid #4ecca3; color: white;
            pointer-events: auto;
        }

        /* MOBILE CONTROLS */
        #mobile-controls { 
            position: absolute; bottom: 10px; width: 100%; 
            display: flex; justify-content: space-between; padding: 0 15px;
            box-sizing: border-box; pointer-events: none; z-index: 30; 
        }
        .control-group { display: flex; gap: 10px; pointer-events: none; }
        
        .ctrl-btn { 
            width: 65px; height: 65px; background: rgba(255,255,255,0.15); 
            border-radius: 50%; pointer-events: auto; display: flex; 
            align-items: center; justify-content: center; font-size: 22px; 
            color: white; border: 2px solid #4ecca3; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-boost-trigger { border-color: #f1c40f; background: rgba(241, 196, 15, 0.2); font-size: 12px; font-weight: bold; color: #f1c40f; }
        .ctrl-btn:active { background: rgba(78, 204, 163, 0.5); transform: scale(0.92); }

        #leaderboard-panel {
            width: 100%; background: #16213e; border-top: 2px solid #4ecca3;
            padding: 10px; box-sizing: border-box; flex: 1; overflow-y: auto;
        }
        .score-entry { display: flex; justify-content: space-between; padding: 6px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #ccc; }
        
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #333; padding: 20px; border-radius: 12px; width: 260px; z-index: 100; text-align: center; }
        #game-over-modal { background: #1a1a2e; color: white; border: 2px solid #e94560; }
        .btn-blue { background: #3498db; color: white; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }
        .btn-red { background: #e94560; color: white; width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none;}

        #user-nav { position: absolute; top: 10px; right: 10px; z-index: 50; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 8px; font-size: 11px; color: white; border: 1px solid #4ecca3; }
        .auth-box { background: white; color: #333; padding: 30px; border-radius: 15px; width: 300px; margin: 80px auto; text-align: center; }
    </style>
</head>
<body>

    <div id="user-nav" class="hidden">
        <span id="nav-name">Player</span> | Best: <span id="nav-pb" style="color:#4ecca3">0</span>m
        <button onclick="logout()" style="background:none; border:none; color:#e94560; font-weight:bold; cursor:pointer; margin-left:10px;">Logout</button>
    </div>

    <div id="auth-screen" class="auth-box">
        <h2>The High Climb</h2>
        <input type="email" id="email" placeholder="Email" style="width:90%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
        <input type="password" id="password" placeholder="Password" style="width:90%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
        <button class="btn-blue" style="width:100%" onclick="handleAuth()">Play Now</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="game-viewport">
            <div id="hud">
                <div class="stat-box">Altitude: <span id="alt-score" style="color:#4ecca3">0</span>m</div><br>
                <div class="stat-box">Boosts: <span id="boost-count" style="color:#f1c40f">0</span></div><br>
                <button class="btn-blue" style="font-size:10px; pointer-events:auto;" onclick="triggerQuiz()">+ EARN BOOST</button>
            </div>

            <div id="mobile-controls">
                <div class="control-group">
                    <div class="ctrl-btn" id="btn-left">‚óÄ</div>
                    <div class="ctrl-btn" id="btn-right">‚ñ∂</div>
                </div>
                <div class="control-group">
                    <div class="ctrl-btn btn-boost-trigger" id="btn-boost">BOOST</div>
                    <div class="ctrl-btn" id="btn-jump">UP</div>
                </div>
            </div>

            <div id="quiz-box" class="modal hidden">
                <h3 id="question" style="margin-top:0">Quiz</h3>
                <div id="options"></div>
            </div>

            <div id="game-over-modal" class="modal hidden">
                <h2 style="color:#e94560;">CRASHED!</h2>
                <p>Score: <span id="final-alt" style="color:#4ecca3">0</span>m</p>
                <button class="btn-red" onclick="resetGameFast()">RETRY</button>
            </div>

            <canvas id="gameCanvas"></canvas>
        </div>

        <div id="leaderboard-panel">
            <div style="color:#4ecca3; font-weight:bold; margin-bottom:5px;">üèÜ TOP CLIMBERS</div>
            <div id="leaderboard-list">Loading...</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xpqbrytsxsswjabonbox.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwcWJyeXRzeHNzd2phYm9uYm94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjUsImV4cCI6MjA4MTYwNDc2NX0.elSX1XfvfAAJZyW-6JBhMpONz1zuBBH7GZiV-Vax0EE';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, isPaused = false, bestAltitude = 0;
        let boosts = 0, currentAltitude = 0, cameraY = 0;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 600;

        const GRAVITY = 0.48, JUMP_FORCE = -11.5, BOOST_FORCE = -20;
        let player = { x: 185, y: 540, w: 30, h: 30, vx: 0, vy: 0, onGround: false };
        let platforms = [], keys = {};

        function setupInputs() {
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            const controls = document.getElementById('mobile-controls');
            
            if (isTouch) {
                controls.style.display = 'flex';
                const bind = (id, key, specialAction = null) => {
                    const el = document.getElementById(id);
                    const press = (e) => { e.preventDefault(); if (specialAction) specialAction(); else keys[key] = true; };
                    const release = (e) => { e.preventDefault(); keys[key] = false; };
                    el.addEventListener('touchstart', press, {passive: false});
                    el.addEventListener('touchend', release, {passive: false});
                    el.addEventListener('mousedown', press);
                    el.addEventListener('mouseup', release);
                };

                bind('btn-left', 'ArrowLeft');
                bind('btn-right', 'ArrowRight');
                bind('btn-jump', 'Space', () => { if(player.onGround && !isPaused) { player.vy = JUMP_FORCE; player.onGround = false; }});
                bind('btn-boost', 'Shift', () => { if(boosts > 0 && !isPaused) { boosts--; player.vy = BOOST_FORCE; player.onGround = false; updateHUD(); }});
            } else {
                controls.style.display = 'none';
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value, password = document.getElementById('password').value;
            const { error } = await sbClient.auth.signInWithPassword({ email, password });
            if (error) await sbClient.auth.signUp({ email, password });
            checkSession();
        }

        async function checkSession() {
            const { data: { session } } = await sbClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('nav-name').innerText = currentUser.email.split('@')[0];
                const { data } = await sbClient.from('scores').select('time_taken').eq('user_id', currentUser.id).maybeSingle();
                if (data) { bestAltitude = data.time_taken; document.getElementById('nav-pb').innerText = bestAltitude; }
                initGame(); loadLeaderboard();
            }
        }

        function initGame() {
            platforms = []; cameraY = 0; currentAltitude = 0; boosts = 0;
            player.x = 185; player.y = 540; player.vy = 0; player.vx = 0;
            isPaused = false; updateHUD();
            document.getElementById('game-over-modal').classList.add('hidden');
            platforms.push({ x: 0, y: 580, w: 400, h: 20, level: 0 });
            for(let i = 1; i < 1000; i++) platforms.push({ x: Math.random() * 310 + 5, y: 580 - (i * 130), w: 85, h: 12, level: i });
            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'Space' && player.onGround && !isPaused) { player.vy = JUMP_FORCE; player.onGround = false; }
            if ((e.code === 'ShiftLeft' || e.code === 'ShiftRight') && boosts > 0 && !isPaused) { boosts--; player.vy = BOOST_FORCE; updateHUD(); }
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function updateHUD() {
            document.getElementById('boost-count').innerText = boosts;
            document.getElementById('alt-score').innerText = currentAltitude;
        }

        function gameLoop() { if (!isPaused) { update(); draw(); requestAnimationFrame(gameLoop); } }

        function update() {
            if (keys['ArrowLeft']) player.vx = -5; else if (keys['ArrowRight']) player.vx = 5; else player.vx *= 0.8;
            player.vy += GRAVITY; player.x += player.vx; player.y += player.vy;
            if (player.y - 320 < cameraY) cameraY = player.y - 320;
            if (player.x < 0) player.x = 0; if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;
            player.onGround = false;
            platforms.forEach(p => {
                if (player.vy > 0 && player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h >= p.y && player.y + player.h <= p.y + 15) {
                    player.y = p.y - player.h; player.vy = 0; player.onGround = true;
                    if (p.level > currentAltitude) { currentAltitude = p.level; updateHUD(); }
                }
            });
            if (player.y > cameraY + canvas.height + 50) handleDeath();
        }

        async function handleDeath() {
            isPaused = true;
            document.getElementById('final-alt').innerText = currentAltitude;
            document.getElementById('game-over-modal').classList.remove('hidden');
            if (currentAltitude > bestAltitude) {
                bestAltitude = currentAltitude;
                document.getElementById('nav-pb').innerText = bestAltitude;
                await sbClient.from('scores').upsert({ user_id: currentUser.id, display_name: currentUser.email.split('@')[0], time_taken: currentAltitude }, { onConflict: 'user_id' });
                loadLeaderboard();
            }
        }

        function resetGameFast() { initGame(); }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save(); ctx.translate(0, -cameraY);
            platforms.forEach(p => { if (p.y > cameraY - 100 && p.y < cameraY + 700) { ctx.fillStyle = '#4ecca3'; ctx.fillRect(p.x, p.y, p.w, p.h); }});
            ctx.fillStyle = '#e94560'; ctx.fillRect(player.x, player.y, player.w, player.h); ctx.restore();
        }

        function triggerQuiz() {
            isPaused = true;
            const n1 = Math.floor(Math.random()*9)+2, n2 = Math.floor(Math.random()*9)+2, ans = n1 * n2;
            const q = { q: `${n1} x ${n2}`, a: [ans, ans+2, ans-1].sort(() => Math.random()-0.5), c: ans };
            document.getElementById('quiz-box').classList.remove('hidden');
            document.getElementById('question').innerText = q.q;
            const optDiv = document.getElementById('options'); optDiv.innerHTML = '';
            q.a.forEach(opt => {
                const b = document.createElement('button'); b.className = 'btn-blue'; b.style.width="100%"; b.style.marginBottom="5px"; b.innerText = opt;
                b.onclick = () => { if(opt === q.c) { boosts++; updateHUD(); } isPaused = false; document.getElementById('quiz-box').classList.add('hidden'); requestAnimationFrame(gameLoop); };
                optDiv.appendChild(b);
            });
        }

        async function loadLeaderboard() {
            const { data } = await sbClient.from('scores').select('display_name, time_taken').order('time_taken', { ascending: false }).limit(5);
            if (data) document.getElementById('leaderboard-list').innerHTML = data.map((s, i) => `<div class="score-entry"><span><span class="rank-num">#${i+1}</span>${s.display_name}</span> <b>${s.time_taken}m</b></div>`).join('');
        }

        async function logout() { await sbClient.auth.signOut(); location.reload(); }
        
        // INITIALIZE INPUTS IMMEDIATELY
        setupInputs();
        checkSession();
    </script>
</body>
</html>