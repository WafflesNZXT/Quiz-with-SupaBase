<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Royale: 2D Battle</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: #2c3e50; color: white; overflow-x: hidden; }
        .hidden { display: none; }
        
        /* 2D Battlefield */
        #battlefield-container { background: #27ae60; border-bottom: 5px solid #2ecc71; position: relative; height: 150px; width: 100%; overflow: hidden; }
        canvas { display: block; }

        /* Game UI */
        #ui-layer { padding: 15px; background: #34495e; }
        .elixir-bar { background: #222; border-radius: 20px; width: 200px; height: 25px; margin: 10px auto; position: relative; border: 2px solid #8e44ad; }
        #elixir-progress { background: #ff00ff; width: 0%; height: 100%; border-radius: 18px; transition: width 0.3s; }
        #elixir-text { position: absolute; width: 100%; text-align: center; top: 2px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }

        /* Quiz Styling */
        #game-content { padding: 20px; max-width: 500px; margin: 0 auto; }
        #quiz { background: white; color: #333; padding: 20px; border-radius: 15px; box-shadow: 0 10px 0 #bdc3c7; }
        button { padding: 12px 20px; margin: 5px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; transition: 0.1s; }
        .btn-blue { background: #3498db; color: white; border-bottom: 4px solid #2980b9; }
        .btn-blue:disabled { background: #7f8c8d; border: none; }
        .option-btn { width: 100%; background: #ecf0f1; color: #333; border-bottom: 4px solid #bdc3c7; }

        /* Ice Overlay */
        #ice-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(135, 206, 250, 0.9); backdrop-filter: blur(5px);
            z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center;
        }

        #leaderboard { background: rgba(0,0,0,0.3); padding: 10px; margin-top: 20px; border-radius: 10px; }
        .score-entry { padding: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="ice-overlay">
        <div style="background: white; color: #2980b9; padding: 30px; border-radius: 20px;">
            <h2>‚ùÑÔ∏è FROZEN! ‚ùÑÔ∏è</h2>
            <p>Solve 3 to break free!</p>
            <div id="ice-question" style="font-size: 24px; margin-bottom: 10px; font-weight: bold;"></div>
            <div id="ice-options"></div>
        </div>
    </div>

    <div id="battlefield-container">
        <canvas id="battleCanvas"></canvas>
    </div>

    <div id="ui-layer">
        <div id="setup">
            <input type="text" id="username" placeholder="Name" style="padding: 10px; border-radius: 5px;">
            <button class="btn-blue" onclick="startQuiz()">Enter Arena</button>
        </div>

        <div id="game-stats" class="hidden">
            <div class="elixir-bar">
                <div id="elixir-progress"></div>
                <div id="elixir-text">üíß 0 / 10</div>
            </div>
            <button id="freeze-btn" class="btn-blue" onclick="spawnTroop()" disabled>Deploy Knight (5üíß)</button>
        </div>
    </div>

    <div id="game-content">
        <div id="quiz" class="hidden">
            <h2 id="question">Loading...</h2>
            <div id="options"></div>
        </div>

        <div id="results" class="hidden">
            <h2>Finish!</h2>
            <p id="final-time"></p>
            <button class="btn-blue" onclick="restartMatch()">Next Match</button>
        </div>

        <div id="leaderboard">
            <div id="pb-text">Best: None</div>
            <hr>
            <div id="leaderboard-list">Loading Arena Rankings...</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xpqbrytsxsswjabonbox.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwcWJyeXRzeHNzd2phYm9uYm94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjUsImV4cCI6MjA4MTYwNDc2NX0.elSX1XfvfAAJZyW-6JBhMpONz1zuBBH7GZiV-Vax0EE';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- CANVAS ENGINE ---
        const canvas = document.getElementById('battleCanvas');
        const ctx = canvas.getContext('2d');
        let troops = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = 150;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function spawnTroopVisual(isMine = true) {
            troops.push({
                x: isMine ? 0 : canvas.width,
                y: 75,
                speed: isMine ? 3 : -3,
                emoji: isMine ? '‚öîÔ∏è' : 'üî•'
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Bridge
            ctx.fillStyle = '#8e44ad';
            ctx.fillRect(0, 70, canvas.width, 10);

            // Draw Troops
            ctx.font = '30px serif';
            troops.forEach((t, index) => {
                t.x += t.speed;
                ctx.fillText(t.emoji, t.x, t.y + 10);

                // If my troop reaches the end, trigger attack
                if (t.x > canvas.width && t.speed > 0) {
                    sendAttack();
                    troops.splice(index, 1);
                }
                // If enemy troop reaches me
                if (t.x < 0 && t.speed < 0) {
                    applyFreezeEffect();
                    troops.splice(index, 1);
                }
            });
            requestAnimationFrame(draw);
        }
        draw();

        // --- GAME LOGIC ---
        const questions = [
            { q: "What is 10 + 10?", a: ["20", "21", "19"], correct: "20" },
            { q: "Which is the main resource?", a: ["Gold", "Elixir", "Wood"], correct: "Elixir" },
            { q: "Cost of a Knight?", a: ["3", "5", "8"], correct: "5" }
        ];

        let currentQ = 0, startTime, username = "", elixir = 0, isFrozen = false, iceCount = 0;

        const arenaChannel = sbClient.channel('arena-room').on('broadcast', { event: 'freeze_attack' }, () => {
            spawnTroopVisual(false); // Enemy troop appears!
        }).subscribe();

        function startQuiz() {
            username = document.getElementById('username').value.trim();
            if(!username) return alert("Enter Name");
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game-stats').classList.remove('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            startTime = Date.now();
            showQuestion();
            startPassiveElixir();
        }

        function startPassiveElixir() {
            setInterval(() => {
                if (elixir < 10) {
                    elixir += 0.5;
                    updateElixirUI();
                }
            }, 1500);
        }

        function showQuestion() {
            const q = questions[currentQ];
            document.getElementById('question').innerText = q.q;
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            q.a.forEach(opt => {
                const b = document.createElement('button');
                b.className = 'option-btn';
                b.innerText = opt;
                b.onclick = () => {
                    if(opt === q.correct) {
                        elixir = Math.min(10, elixir + 2);
                        updateElixirUI();
                        currentQ++;
                        if(currentQ < questions.length) showQuestion(); else finishQuiz();
                    } else alert("Wrong!");
                };
                optDiv.appendChild(b);
            });
        }

        function updateElixirUI() {
            const perc = (elixir / 10) * 100;
            document.getElementById('elixir-progress').style.width = perc + '%';
            document.getElementById('elixir-text').innerText = `üíß ${Math.floor(elixir)} / 10`;
            document.getElementById('freeze-btn').disabled = (elixir < 5);
        }

        function spawnTroop() {
            if (elixir >= 5) {
                elixir -= 5;
                updateElixirUI();
                spawnTroopVisual(true);
            }
        }

        function sendAttack() {
            arenaChannel.send({ type: 'broadcast', event: 'freeze_attack', payload: { user: username } });
        }

        function applyFreezeEffect() {
            if (isFrozen) return;
            isFrozen = true; iceCount = 0;
            document.getElementById('ice-overlay').style.display = 'flex';
            showIceQ();
        }

        function showIceQ() {
            const n1 = Math.floor(Math.random()*10), n2 = Math.floor(Math.random()*10), ans = n1+n2;
            document.getElementById('ice-question').innerText = `${n1} + ${n2} = ?`;
            const div = document.getElementById('ice-options');
            div.innerHTML = '';
            [ans, ans+1, ans-1].sort(() => Math.random()-0.5).forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-blue'; b.innerText = o;
                b.onclick = () => {
                    if(parseInt(o) === ans) {
                        iceCount++;
                        if(iceCount >= 3) { isFrozen = false; document.getElementById('ice-overlay').style.display = 'none'; }
                        else showIceQ();
                    }
                };
                div.appendChild(b);
            });
        }

        async function finishQuiz() {
            const time = (Date.now() - startTime)/1000;
            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('final-time').innerText = `Time: ${time}s`;
            await sbClient.from('scores').upsert({ username, time_taken: time }, { onConflict: 'username' });
            loadLeaderboard();
        }

        function restartMatch() {
            currentQ = 0;
            document.getElementById('results').classList.add('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            startTime = Date.now();
            showQuestion();
        }

        async function loadLeaderboard() {
            const { data } = await sbClient.from('scores').select('*').order('time_taken', { ascending: true }).limit(10);
            if (data) {
                document.getElementById('leaderboard-list').innerHTML = data.map((s, i) => `<div class="score-entry">${i+1}. ${s.username}: ${s.time_taken}s</div>`).join('');
            }
        }
        loadLeaderboard();
    </script>
</body>
</html>