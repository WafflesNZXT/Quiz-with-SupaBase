<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Royale: Battle Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background: #f0f2f5; transition: filter 0.3s; }
        .hidden { display: none; }
        
        /* Game UI */
        #game-ui { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; align-items: center; }
        .elixir-container { background: #34495e; padding: 10px 20px; border-radius: 30px; color: #ff00ff; font-weight: bold; border: 3px solid #8e44ad; box-shadow: 0 4px 0 #71368a; }
        
        button { padding: 12px 24px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        
        .btn-attack { background: #3498db; color: white; border-bottom: 4px solid #2980b9; }
        .btn-attack:disabled { background: #bdc3c7; border: none; cursor: not-allowed; }
        
        /* Quiz Styling */
        #quiz { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; position: relative; }
        .option-btn { width: 100%; margin: 8px 0; background: #ecf0f1; border-bottom: 4px solid #d5dbdb; font-size: 18px; }
        .option-btn:hover { background: #dde4e6; }

        /* Ice Effect */
        #ice-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(135, 206, 250, 0.6); backdrop-filter: blur(8px);
            z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 40px; font-weight: bold; text-shadow: 0 0 20px #000;
        }

        /* Leaderboard */
        #leaderboard { margin-top: 30px; border-top: 2px solid #ccc; padding-top: 10px; }
        .score-entry { background: white; margin: 5px auto; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 300px; }
        #pb-container { margin-bottom: 10px; color: #2c3e50; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ice-overlay">
        ‚ùÑÔ∏è FROZEN! ‚ùÑÔ∏è
        <div style="font-size: 18px;">Someone used a Freeze Spell!</div>
    </div>

    <h1>Quiz Royale: Battle Mode</h1>

    <div id="setup">
        <input type="text" id="username" placeholder="Enter Name">
        <button class="btn-attack" onclick="startQuiz()">Enter Arena</button>
    </div>

    <div id="game-ui" class="hidden">
        <div class="elixir-container">üíß Elixir: <span id="elixir-count">0</span></div>
        <button id="freeze-btn" class="btn-attack" onclick="useFreeze()" disabled>Freeze Others (5üíß)</button>
    </div>

    <div id="pb-container" class="hidden">
        <span id="pb-text">Personal Best: None</span>
    </div>

    <div id="quiz" class="hidden">
        <h2 id="question">Loading...</h2>
        <div id="options"></div>
    </div>

    <div id="results" class="hidden">
        <h2>Match Finished!</h2>
        <p id="final-time"></p>
        <button class="btn-attack" onclick="location.reload()">New Match</button>
    </div>

    <div id="leaderboard">
        <h3>üèÜ Arena Rankings</h3>
        <div id="leaderboard-list">Loading scores...</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xpqbrytsxsswjabonbox.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwcWJyeXRzeHNzd2phYm9uYm94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjUsImV4cCI6MjA4MTYwNDc2NX0.elSX1XfvfAAJZyW-6JBhMpONz1zuBBH7GZiV-Vax0EE';
        
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const questions = [
            { q: "What is 5 + 5?", a: ["10", "12", "8"], correct: "10" },
            { q: "Which game uses 'Elixir'?", a: ["Chess", "Clash Royale", "Monopoly"], correct: "Clash Royale" },
            { q: "What is the cost of a Freeze spell here?", a: ["3", "5", "10"], correct: "5" },
            { q: "Best color for Elixir?", a: ["Red", "Green", "Pink/Purple"], correct: "Pink/Purple" }
        ];

        let currentQ = 0;
        let startTime;
        let username = "";
        let personalBest = null;
        let elixir = 0;

        // Initialize Broadcast Channel
        const arenaChannel = sbClient.channel('arena-room', {
            config: { broadcast: { self: false } } // Don't freeze yourself!
        });

        // LISTEN FOR ATTACKS FROM OTHERS
        arenaChannel.on('broadcast', { event: 'freeze_attack' }, (payload) => {
            console.log("Incoming attack from:", payload.payload.user);
            applyFreezeEffect();
        }).subscribe();

        async function startQuiz() {
            username = document.getElementById('username').value.trim();
            if(!username) return alert("Enter a name!");
            
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('pb-container').classList.remove('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            
            await fetchPersonalBest();
            startTime = Date.now();
            showQuestion();
        }

        async function fetchPersonalBest() {
            const { data } = await sbClient.from('scores').select('time_taken').eq('username', username).maybeSingle();
            if (data) {
                personalBest = data.time_taken;
                document.getElementById('pb-text').innerText = `Personal Best: ${personalBest}s`;
            }
        }

        function showQuestion() {
            const qData = questions[currentQ];
            document.getElementById('question').innerText = qData.q;
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            qData.a.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt);
                optionsDiv.appendChild(btn);
            });
        }

        async function handleAnswer(choice) {
            if(choice === questions[currentQ].correct) {
                // ELIXIR LOGIC
                elixir += 2;
                updateElixirUI();

                currentQ++;
                if(currentQ < questions.length) {
                    showQuestion();
                } else {
                    finishQuiz();
                }
            } else {
                alert("Wrong! Try again.");
            }
        }

        function updateElixirUI() {
            document.getElementById('elixir-count').innerText = elixir;
            document.getElementById('freeze-btn').disabled = (elixir < 5);
        }

        // ACTION: USE FREEZE
        function useFreeze() {
            if (elixir >= 5) {
                elixir -= 5;
                updateElixirUI();
                
                // SEND ATTACK TO EVERYONE ELSE
                arenaChannel.send({
                    type: 'broadcast',
                    event: 'freeze_attack',
                    payload: { user: username }
                });
            }
        }

        // REACTION: GET FROZEN
        function applyFreezeEffect() {
            const overlay = document.getElementById('ice-overlay');
            overlay.style.display = 'flex';
            
            // Hide after 3 seconds
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 3000);
        }

        async function finishQuiz() {
            const timeTaken = (Date.now() - startTime) / 1000;
            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('final-time').innerText = `Battle Time: ${timeTaken}s`;

            if (personalBest === null || timeTaken < personalBest) {
                await sbClient.from('scores').upsert({ username: username, time_taken: timeTaken }, { onConflict: 'username' });
                personalBest = timeTaken;
                document.getElementById('pb-text').innerText = `New Record: ${timeTaken}s!`;
            }
        }

        async function loadLeaderboard() {
            const { data } = await sbClient.from('scores').select('*').order('time_taken', { ascending: true }).limit(10);
            const list = document.getElementById('leaderboard-list');
            if (data) {
                list.innerHTML = data.map((s, i) => `<div class="score-entry">${i < 3 ? ['ü•á','ü•à','ü•â'][i] : ''} <strong>${s.username}</strong>: ${s.time_taken}s</div>`).join('');
            }
        }

        sbClient.channel('db-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'scores' }, () => {
            loadLeaderboard();
        }).subscribe();

        loadLeaderboard();
    </script>
</body>
</html>