<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quiz Royale: The High Climb</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html, body { 
            overflow: hidden; width: 100%; height: 100%; margin: 0; padding: 0; 
            background: #1a1a2e; font-family: 'Segoe UI', sans-serif;
            touch-action: none; display: flex; flex-direction: column;
        }
        .hidden { display: none !important; }

        #game-container {
            position: relative; flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
        }

        #game-viewport { 
            position: relative; width: 100vw; max-width: 400px; height: 65vh; 
            background: #16213e; border-bottom: 3px solid #4ecca3; overflow: hidden;
        }

        canvas { display: block; background: #0f3460; width: 100%; height: 100%; }

        /* HUD */
        #hud { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 10; }
        .stat-box { 
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 5px; 
            margin-bottom: 5px; font-size: 12px; border-left: 3px solid #4ecca3; color: white;
            pointer-events: auto;
        }

        /* MOBILE CONTROLS */
        #mobile-controls { 
            position: absolute; bottom: 15px; width: 100%; 
            display: flex !important; justify-content: space-between; padding: 0 15px;
            box-sizing: border-box; pointer-events: none; z-index: 100; 
        }
        .control-group { display: flex; gap: 10px; pointer-events: none; }
        
        .ctrl-btn { 
            width: 65px; height: 65px; background: rgba(255,255,255,0.2); 
            border-radius: 50%; pointer-events: auto; display: flex; 
            align-items: center; justify-content: center; font-size: 24px; 
            color: white; border: 2px solid #4ecca3; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-boost-trigger { border-color: #f1c40f; background: rgba(241, 196, 15, 0.3); font-size: 12px; font-weight: bold; color: #f1c40f; }
        .ctrl-btn:active { background: rgba(78, 204, 163, 0.6); transform: scale(0.9); }

        /* LEADERBOARD */
        #leaderboard-panel {
            width: 100%; background: #16213e; flex: 1; padding: 15px; 
            box-sizing: border-box; overflow-y: auto; color: white;
        }
        .score-entry { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* MODALS */
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #333; padding: 20px; border-radius: 12px; width: 260px; z-index: 200; text-align: center; }
        #game-over-modal { background: #1a1a2e; color: white; border: 2px solid #e94560; }
        .btn-blue { background: #3498db; color: white; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }
        
        .auth-box { background: white; color: #333; padding: 30px; border-radius: 15px; width: 300px; margin: 80px auto; text-align: center; }
        #user-nav { position: absolute; top: 10px; right: 10px; z-index: 50; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 8px; font-size: 11px; color: white; border: 1px solid #4ecca3; }
    </style>
</head>
<body>

    <div id="user-nav" class="hidden">
        <span id="nav-name">Player</span> | Best: <span id="nav-pb" style="color:#4ecca3">0</span>m
        <button onclick="logout()" style="background:none; border:none; color:#e94560; font-weight:bold; cursor:pointer; margin-left:10px;">Logout</button>
    </div>

    <div id="auth-screen" class="auth-box">
        <h2>The High Climb</h2>
        <input type="email" id="email" placeholder="Email" style="width:90%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
        <input type="password" id="password" placeholder="Password" style="width:90%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
        <button class="btn-blue" style="width:100%" onclick="handleAuth()">Login / Sign Up</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="game-viewport">
            <div id="hud">
                <div class="stat-box">Altitude: <span id="alt-score">0</span>m</div>
                <div class="stat-box">Boosts: <span id="boost-count">0</span></div>
                <button class="btn-blue" style="font-size:10px;" onclick="triggerQuiz()">+ BOOST</button>
            </div>

            <div id="mobile-controls">
                <div class="control-group">
                    <div class="ctrl-btn" id="btn-left">‚óÄ</div>
                    <div class="ctrl-btn" id="btn-right">‚ñ∂</div>
                </div>
                <div class="control-group">
                    <div class="ctrl-btn btn-boost-trigger" id="btn-boost">BOOST</div>
                    <div class="ctrl-btn" id="btn-jump">UP</div>
                </div>
            </div>

            <canvas id="gameCanvas"></canvas>

            <div id="quiz-box" class="modal hidden">
                <h3 id="question">Quiz</h3>
                <div id="options"></div>
            </div>

            <div id="game-over-modal" class="modal hidden">
                <h2 style="color:#e94560;">CRASHED!</h2>
                <button class="btn-blue" onclick="initGame()">RETRY</button>
            </div>
        </div>

        <div id="leaderboard-panel">
            <h3 style="color:#4ecca3; margin-top:0;">üèÜ LEADERBOARD</h3>
            <div id="leaderboard-list">Loading...</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xpqbrytsxsswjabonbox.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwcWJyeXRzeHNzd2phYm9uYm94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjUsImV4cCI6MjA4MTYwNDc2NX0.elSX1XfvfAAJZyW-6JBhMpONz1zuBBH7GZiV-Vax0EE';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, isPaused = false, boosts = 0, currentAltitude = 0, cameraY = 0, bestAltitude = 0;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 600;

        let player = { x: 185, y: 540, w: 30, h: 30, vx: 0, vy: 0, onGround: false };
        let platforms = [], keys = {};

        // Keyboard support
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'Space' && player.onGround && !isPaused) player.vy = -11.5;
            if ((e.code === 'ShiftLeft' || e.code === 'ShiftRight') && boosts > 0 && !isPaused) {
                boosts--; player.vy = -20; updateHUD();
            }
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        // Mobile button support
        function bindButtons() {
            const add = (id, key, action = null) => {
                const el = document.getElementById(id);
                const start = (e) => { 
                    e.preventDefault(); 
                    if(action) action(); 
                    else keys[key] = true; 
                };
                const end = (e) => { 
                    e.preventDefault(); 
                    keys[key] = false; 
                };
                el.addEventListener('touchstart', start, {passive: false}); 
                el.addEventListener('touchend', end);
                el.addEventListener('mousedown', start); 
                el.addEventListener('mouseup', end);
            };
            add('btn-left', 'ArrowLeft');
            add('btn-right', 'ArrowRight');
            add('btn-jump', 'Space', () => { if(player.onGround && !isPaused) player.vy = -11.5; });
            add('btn-boost', 'ShiftLeft', () => { if(boosts > 0 && !isPaused) { boosts--; player.vy = -20; updateHUD(); }});
        }

        async function handleAuth() {
            const email = document.getElementById('email').value, password = document.getElementById('password').value;
            const { error } = await sbClient.auth.signInWithPassword({ email, password });
            if (error) await sbClient.auth.signUp({ email, password });
            checkSession();
        }

        async function checkSession() {
            const { data: { session } } = await sbClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('nav-name').innerText = currentUser.email.split('@')[0];
                
                const { data } = await sbClient.from('scores').select('time_taken').eq('user_id', currentUser.id).maybeSingle();
                if (data) { bestAltitude = data.time_taken; document.getElementById('nav-pb').innerText = bestAltitude; }

                bindButtons();
                initGame();
                loadLeaderboard();
            }
        }

        function initGame() {
            platforms = []; cameraY = 0; currentAltitude = 0; boosts = 0;
            player.x = 185; player.y = 540; player.vy = 0; player.vx = 0;
            isPaused = false;
            document.getElementById('game-over-modal').classList.add('hidden');
            platforms.push({ x: 0, y: 580, w: 400, h: 20, level: 0 });
            for(let i = 1; i < 1000; i++) platforms.push({ x: Math.random()*310, y: 580-(i*130), w: 85, h: 12, level: i });
            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        function updateHUD() {
            document.getElementById('alt-score').innerText = currentAltitude;
            document.getElementById('boost-count').innerText = boosts;
        }

        function gameLoop() {
            if (isPaused) return;

            // Physics logic for both Keyboard and Buttons
            if (keys['ArrowLeft'] || keys['KeyA']) player.vx = -5; 
            else if (keys['ArrowRight'] || keys['KeyD']) player.vx = 5; 
            else player.vx *= 0.8;

            player.vy += 0.48; 
            player.x += player.vx; 
            player.y += player.vy;

            // Boundary check
            if (player.x < 0) player.x = 0;
            if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;

            if (player.y - 320 < cameraY) cameraY = player.y - 320;
            
            player.onGround = false;
            platforms.forEach(p => {
                if (player.vy > 0 && player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h >= p.y && player.y + player.h <= p.y + 15) {
                    player.y = p.y - player.h; player.vy = 0; player.onGround = true;
                    if (p.level > currentAltitude) { currentAltitude = p.level; updateHUD(); }
                }
            });

            if (player.y > cameraY + canvas.height + 100) {
                isPaused = true;
                document.getElementById('game-over-modal').classList.remove('hidden');
                saveScore();
            }

            ctx.clearRect(0,0,400,600);
            ctx.save(); ctx.translate(0, -cameraY);
            platforms.forEach(p => { 
                if (p.y > cameraY - 100 && p.y < cameraY + 700) {
                    ctx.fillStyle = '#4ecca3'; ctx.fillRect(p.x, p.y, p.w, p.h); 
                }
            });
            ctx.fillStyle = '#e94560'; ctx.fillRect(player.x, player.y, player.w, player.h);
            ctx.restore();
            requestAnimationFrame(gameLoop);
        }

        function triggerQuiz() {
            isPaused = true;
            document.getElementById('quiz-box').classList.remove('hidden');
            const n1 = Math.floor(Math.random()*9)+2, n2 = Math.floor(Math.random()*9)+2, ans = n1*n2;
            document.getElementById('question').innerText = `${n1} x ${n2}?`;
            const optDiv = document.getElementById('options'); optDiv.innerHTML = '';
            [ans, ans+2, ans-3].sort(()=>Math.random()-0.5).forEach(o => {
                const b = document.createElement('button'); b.innerText = o; b.className = 'btn-blue'; b.style.margin="5px";
                b.onclick = () => { if(o === ans) boosts++; isPaused = false; document.getElementById('quiz-box').classList.add('hidden'); updateHUD(); requestAnimationFrame(gameLoop); };
                optDiv.appendChild(b);
            });
        }

        async function saveScore() {
            if (currentAltitude > bestAltitude) {
                bestAltitude = currentAltitude;
                document.getElementById('nav-pb').innerText = bestAltitude;
                await sbClient.from('scores').upsert({ user_id: currentUser.id, display_name: currentUser.email.split('@')[0], time_taken: currentAltitude });
                loadLeaderboard();
            }
        }

        async function loadLeaderboard() {
            const { data } = await sbClient.from('scores').select('display_name, time_taken').order('time_taken', {ascending: false}).limit(5);
            if (data) document.getElementById('leaderboard-list').innerHTML = data.map(s => `<div class="score-entry"><span>${s.display_name}</span><b>${s.time_taken}m</b></div>`).join('');
        }

        async function logout() { await sbClient.auth.signOut(); location.reload(); }

        checkSession();
    </script>
</body>
</html>