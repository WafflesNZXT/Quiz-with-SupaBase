<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Royale: Accounts Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; background: #2c3e50; color: white; overflow-x: hidden; }
        .hidden { display: none; }
        
        /* 2D Battlefield */
        #battlefield-container { background: #27ae60; border-bottom: 5px solid #2ecc71; position: relative; height: 150px; width: 100%; overflow: hidden; }
        canvas { display: block; }

        /* Auth Styling */
        .auth-box { background: white; color: #333; padding: 25px; border-radius: 15px; width: 320px; margin: 50px auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .auth-box input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        /* Game UI */
        #ui-layer { padding: 15px; background: #34495e; border-bottom: 2px solid #2c3e50; }
        .elixir-bar { background: #222; border-radius: 20px; width: 220px; height: 28px; margin: 10px auto; position: relative; border: 2px solid #8e44ad; }
        #elixir-progress { background: #ff00ff; width: 0%; height: 100%; border-radius: 18px; transition: width 0.3s; box-shadow: 0 0 10px #ff00ff; }
        #elixir-text { position: absolute; width: 100%; text-align: center; top: 3px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; font-size: 14px; }

        /* Quiz & Results */
        #game-content { padding: 20px; max-width: 500px; margin: 0 auto; }
        #quiz { background: white; color: #333; padding: 25px; border-radius: 15px; box-shadow: 0 8px 0 #bdc3c7; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-blue { background: #3498db; color: white; border-bottom: 4px solid #2980b9; width: 100%; max-width: 250px; }
        .btn-blue:active { transform: translateY(2px); border-bottom-width: 2px; }
        .btn-blue:disabled { background: #7f8c8d; border: none; cursor: not-allowed; }
        .option-btn { width: 100%; background: #ecf0f1; color: #333; border-bottom: 4px solid #bdc3c7; }
        .option-btn:hover { background: #d5dbdb; }

        /* Ice Overlay */
        #ice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(135, 206, 250, 0.9); backdrop-filter: blur(8px); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }

        #leaderboard { background: rgba(0,0,0,0.3); padding: 15px; margin-top: 20px; border-radius: 12px; }
        .score-entry { padding: 8px; font-size: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #user-nav { position: absolute; top: 10px; right: 10px; z-index: 50; }
    </style>
</head>
<body>

    <div id="user-nav" class="hidden">
        <span id="nav-name" style="margin-right: 10px; font-weight: bold;"></span>
        <button onclick="logout()" style="background: #e74c3c; color: white; padding: 5px 10px; font-size: 12px;">Logout</button>
    </div>

    <div id="ice-overlay">
        <div style="background: white; color: #2980b9; padding: 30px; border-radius: 20px; box-shadow: 0 0 50px rgba(255,255,255,0.5);">
            <h2>‚ùÑÔ∏è FROZEN! ‚ùÑÔ∏è</h2>
            <p>Solve 3 quick math problems!</p>
            <div id="ice-question" style="font-size: 28px; margin-bottom: 15px; font-weight: bold;"></div>
            <div id="ice-options"></div>
        </div>
    </div>

    <div id="auth-screen" class="auth-box">
        <h2 id="auth-title" style="margin-top: 0;">Battle Login</h2>
        <input type="email" id="email" placeholder="Email Address">
        <input type="password" id="password" placeholder="Password">
        <input type="text" id="display-name" placeholder="In-Game Name" class="hidden">
        
        <button id="auth-submit" class="btn-blue" onclick="handleAuth()">Login</button>
        <p style="color: #3498db; cursor: pointer; font-size: 14px; text-decoration: underline;" onclick="toggleAuthMode()" id="auth-toggle">Need an account? Sign Up</p>
    </div>

    <div id="game-container" class="hidden">
        <div id="battlefield-container">
            <canvas id="battleCanvas"></canvas>
        </div>

        <div id="ui-layer">
            <div id="game-stats">
                <div class="elixir-bar">
                    <div id="elixir-progress"></div>
                    <div id="elixir-text">üíß 0 / 10</div>
                </div>
                <button id="freeze-btn" class="btn-blue" onclick="spawnTroop()" disabled>Deploy Knight (5üíß)</button>
            </div>
        </div>

        <div id="game-content">
            <div id="quiz">
                <h2 id="question">Preparing Match...</h2>
                <div id="options"></div>
            </div>

            <div id="results" class="hidden">
                <h2 style="color: #f1c40f;">üèÜ Match Finished!</h2>
                <p id="final-time" style="font-size: 20px; font-weight: bold;"></p>
                <button class="btn-blue" onclick="restartMatch()">Play Again</button>
            </div>

            <div id="leaderboard">
                <h3 style="margin-top: 0;">üèÜ Arena Rankings</h3>
                <div id="leaderboard-list">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xpqbrytsxsswjabonbox.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwcWJyeXRzeHNzd2phYm9uYm94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjUsImV4cCI6MjA4MTYwNDc2NX0.elSX1XfvfAAJZyW-6JBhMpONz1zuBBH7GZiV-Vax0EE';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- AUTH LOGIC ---
        let isSignUpMode = false;
        let currentUser = null;

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('auth-title').innerText = isSignUpMode ? "Create Account" : "Battle Login";
            document.getElementById('auth-submit').innerText = isSignUpMode ? "Sign Up" : "Login";
            document.getElementById('display-name').classList.toggle('hidden', !isSignUpMode);
            document.getElementById('auth-toggle').innerText = isSignUpMode ? "Already have an account? Login" : "Need an account? Sign Up";
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const displayName = document.getElementById('display-name').value;

            if (isSignUpMode) {
                const { data, error } = await sbClient.auth.signUp({
                    email, password, options: { data: { display_name: displayName } }
                });
                if (error) return alert(error.message);
                alert("Account created! You can now login.");
                toggleAuthMode();
            } else {
                const { data, error } = await sbClient.auth.signInWithPassword({ email, password });
                if (error) return alert(error.message);
                checkSession();
            }
        }

        async function checkSession() {
            const { data: { session } } = await sbClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('nav-name').innerText = currentUser.user_metadata.display_name;
                startQuiz();
            }
        }

        async function logout() {
            await sbClient.auth.signOut();
            location.reload();
        }

        // --- CANVAS ENGINE ---
        const canvas = document.getElementById('battleCanvas');
        const ctx = canvas.getContext('2d');
        let troops = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = 150;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function spawnTroopVisual(isMine = true) {
            troops.push({
                x: isMine ? 0 : canvas.width,
                y: 75,
                speed: isMine ? 3.5 : -3.5,
                emoji: isMine ? '‚öîÔ∏è' : 'üî•'
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#8e44ad';
            ctx.fillRect(0, 70, canvas.width, 10); // The Bridge
            ctx.font = '32px serif';
            
            troops.forEach((t, index) => {
                t.x += t.speed;
                ctx.fillText(t.emoji, t.x, t.y + 10);
                if (t.x > canvas.width && t.speed > 0) {
                    sendAttack();
                    troops.splice(index, 1);
                }
                if (t.x < 0 && t.speed < 0) {
                    applyFreezeEffect();
                    troops.splice(index, 1);
                }
            });
            requestAnimationFrame(draw);
        }
        draw();

        // --- GAME LOGIC ---
        const questions = [
            { q: "What is 10 + 10?", a: ["20", "21", "19"], correct: "20" },
            { q: "Which is the main resource?", a: ["Gold", "Elixir", "Wood"], correct: "Elixir" },
            { q: "Cost of a Knight?", a: ["3", "5", "8"], correct: "5" },
            { q: "What is 12 x 2?", a: ["24", "22", "26"], correct: "24" }
        ];

        let currentQ = 0, startTime, elixir = 0, isFrozen = false, iceCount = 0;

        const arenaChannel = sbClient.channel('arena-room').on('broadcast', { event: 'freeze_attack' }, () => {
            spawnTroopVisual(false);
        }).subscribe();

        function startQuiz() {
            currentQ = 0;
            elixir = 0;
            startTime = Date.now();
            document.getElementById('results').classList.add('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            showQuestion();
            if(!window.elixirLoop) startPassiveElixir();
        }

        function startPassiveElixir() {
            window.elixirLoop = setInterval(() => {
                if (elixir < 10) {
                    elixir += 0.4;
                    updateElixirUI();
                }
            }, 1000);
        }

        function showQuestion() {
            const q = questions[currentQ];
            document.getElementById('question').innerText = q.q;
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            q.a.forEach(opt => {
                const b = document.createElement('button');
                b.className = 'option-btn';
                b.innerText = opt;
                b.onclick = () => {
                    if(opt === q.correct) {
                        elixir = Math.min(10, elixir + 2);
                        updateElixirUI();
                        currentQ++;
                        if(currentQ < questions.length) showQuestion(); else finishQuiz();
                    }
                };
                optDiv.appendChild(b);
            });
        }

        function updateElixirUI() {
            const perc = (elixir / 10) * 100;
            document.getElementById('elixir-progress').style.width = perc + '%';
            document.getElementById('elixir-text').innerText = `üíß ${Math.floor(elixir)} / 10`;
            document.getElementById('freeze-btn').disabled = (elixir < 5);
        }

        function spawnTroop() {
            if (elixir >= 5) {
                elixir -= 5;
                updateElixirUI();
                spawnTroopVisual(true);
            }
        }

        function sendAttack() {
            arenaChannel.send({ type: 'broadcast', event: 'freeze_attack', payload: { user: currentUser.user_metadata.display_name } });
        }

        function applyFreezeEffect() {
            if (isFrozen) return;
            isFrozen = true; iceCount = 0;
            document.getElementById('ice-overlay').style.display = 'flex';
            showIceQ();
        }

        function showIceQ() {
            const n1 = Math.floor(Math.random()*12)+1, n2 = Math.floor(Math.random()*12)+1, ans = n1+n2;
            document.getElementById('ice-question').innerText = `${n1} + ${n2} = ?`;
            const div = document.getElementById('ice-options');
            div.innerHTML = '';
            [ans, ans+2, ans-1].sort(() => Math.random()-0.5).forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-blue'; b.innerText = o;
                b.onclick = () => {
                    if(parseInt(o) === ans) {
                        iceCount++;
                        if(iceCount >= 3) { isFrozen = false; document.getElementById('ice-overlay').style.display = 'none'; }
                        else showIceQ();
                    }
                };
                div.appendChild(b);
            });
        }

        async function finishQuiz() {
            const time = (Date.now() - startTime)/1000;
            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('final-time').innerText = `Battle Time: ${time}s`;
            
            // SAVE TO DATABASE (Linked to UID)
            await sbClient.from('scores').upsert({ 
                user_id: currentUser.id, 
                display_name: currentUser.user_metadata.display_name, 
                time_taken: time 
            }, { onConflict: 'user_id' });
            
            loadLeaderboard();
        }

        function restartMatch() {
            startQuiz();
        }

        async function loadLeaderboard() {
            const { data } = await sbClient.from('scores').select('*').order('time_taken', { ascending: true }).limit(10);
            if (data) {
                document.getElementById('leaderboard-list').innerHTML = data.map((s, i) => 
                    `<div class="score-entry">${i+1}. <strong>${s.display_name}</strong> - ${s.time_taken}s</div>`
                ).join('');
            }
        }

        // Initial check
        checkSession();
        loadLeaderboard();
    </script>
</body>
</html>